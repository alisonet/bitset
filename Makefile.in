.PHONY: all clean test stress install install-headers uninstall

CFLAGS=@CFLAGS@
VERSION=@VERSION@
VERSION_MAJOR=@VERSION_MAJOR@
PREFIX=@PREFIX@
LIBRARY=@LIBRARY@
HEADERS=@HEADERS@
PKGCONFIG_DATA=@LIBRARY@/pkgconfig
TAG=$(shell git describe --abbrev=0 --tags)
PACKAGE="bitset-$(TAG)"

all:
	$(MAKE) -C lib all || exit

test: all
	$(MAKE) -C test test || exit

stress: all
	$(MAKE) -C test stress || exit

install-headers:
	mkdir -p $(DESTDIR)/$(HEADERS)/bitset || exit
	cp -r include/bitset/* $(DESTDIR)/$(HEADERS)/bitset/ || exit
	chmod 644 $(DESTDIR)/$(HEADERS)/bitset/* || exit

install: all install-headers
	mkdir -p $(DESTDIR)/$(LIBRARY) || exit
	cp -d lib/libbitset.so* $(DESTDIR)/$(LIBRARY)/ || exit
	strip $(DESTDIR)/$(LIBRARY)/libbitset.so.$(VERSION) || exit
	mkdir -p $(DESTDIR)/$(PKGCONFIG_DATA) || exit
	chmod 755 $(DESTDIR)/$(PKGCONFIG_DATA)
	cp build/bitset.pc $(DESTDIR)/$(PKGCONFIG_DATA)/bitset.pc || exit
	cp lib/libbitset.a $(DESTDIR)/$(LIBRARY)/libbitset.a || exit
	chmod 644 $(DESTDIR)/$(LIBRARY)/libbitset.a || exit

uninstall:
	rm -f $(DESTDIR)/$(LIBRARY)/libbitset.so*
	rm -f $(DESTDIR)/$(LIBRARY)/libbitset.a
	rm -rf $(DESTDIR)/$(HEADERS)/bitset
	rm -f $(DESTDIR)/$(PKGCONFIG_DATA)/bitset.pc

dist:
	@git archive --prefix="$(PACKAGE)/" ${TAG} | bzip2 > $(PACKAGE).tar.bz2
	@echo "Created $(PACKAGE).tar.bz2"


clean:
	$(MAKE) -C lib clean
	$(MAKE) -C test clean
	rm -f *~ *.o
